<!DOCTYPE html>
<html>
<head>
<title>README.md</title>
<meta http-equiv="Content-type" content="text/html;charset=UTF-8">

<style>
/* https://github.com/microsoft/vscode/blob/master/extensions/markdown-language-features/media/markdown.css */
/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/

body {
	font-family: var(--vscode-markdown-font-family, -apple-system, BlinkMacSystemFont, "Segoe WPC", "Segoe UI", "Ubuntu", "Droid Sans", sans-serif);
	font-size: var(--vscode-markdown-font-size, 14px);
	padding: 0 26px;
	line-height: var(--vscode-markdown-line-height, 22px);
	word-wrap: break-word;
}

#code-csp-warning {
	position: fixed;
	top: 0;
	right: 0;
	color: white;
	margin: 16px;
	text-align: center;
	font-size: 12px;
	font-family: sans-serif;
	background-color:#444444;
	cursor: pointer;
	padding: 6px;
	box-shadow: 1px 1px 1px rgba(0,0,0,.25);
}

#code-csp-warning:hover {
	text-decoration: none;
	background-color:#007acc;
	box-shadow: 2px 2px 2px rgba(0,0,0,.25);
}

body.scrollBeyondLastLine {
	margin-bottom: calc(100vh - 22px);
}

body.showEditorSelection .code-line {
	position: relative;
}

body.showEditorSelection .code-active-line:before,
body.showEditorSelection .code-line:hover:before {
	content: "";
	display: block;
	position: absolute;
	top: 0;
	left: -12px;
	height: 100%;
}

body.showEditorSelection li.code-active-line:before,
body.showEditorSelection li.code-line:hover:before {
	left: -30px;
}

.vscode-light.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(0, 0, 0, 0.15);
}

.vscode-light.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(0, 0, 0, 0.40);
}

.vscode-light.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

.vscode-dark.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(255, 255, 255, 0.4);
}

.vscode-dark.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(255, 255, 255, 0.60);
}

.vscode-dark.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

.vscode-high-contrast.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(255, 160, 0, 0.7);
}

.vscode-high-contrast.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(255, 160, 0, 1);
}

.vscode-high-contrast.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

img {
	max-width: 100%;
	max-height: 100%;
}

a {
	text-decoration: none;
}

a:hover {
	text-decoration: underline;
}

a:focus,
input:focus,
select:focus,
textarea:focus {
	outline: 1px solid -webkit-focus-ring-color;
	outline-offset: -1px;
}

hr {
	border: 0;
	height: 2px;
	border-bottom: 2px solid;
}

h1 {
	padding-bottom: 0.3em;
	line-height: 1.2;
	border-bottom-width: 1px;
	border-bottom-style: solid;
}

h1, h2, h3 {
	font-weight: normal;
}

table {
	border-collapse: collapse;
}

table > thead > tr > th {
	text-align: left;
	border-bottom: 1px solid;
}

table > thead > tr > th,
table > thead > tr > td,
table > tbody > tr > th,
table > tbody > tr > td {
	padding: 5px 10px;
}

table > tbody > tr + tr > td {
	border-top: 1px solid;
}

blockquote {
	margin: 0 7px 0 5px;
	padding: 0 16px 0 10px;
	border-left-width: 5px;
	border-left-style: solid;
}

code {
	font-family: Menlo, Monaco, Consolas, "Droid Sans Mono", "Courier New", monospace, "Droid Sans Fallback";
	font-size: 1em;
	line-height: 1.357em;
}

body.wordWrap pre {
	white-space: pre-wrap;
}

pre:not(.hljs),
pre.hljs code > div {
	padding: 16px;
	border-radius: 3px;
	overflow: auto;
}

pre code {
	color: var(--vscode-editor-foreground);
	tab-size: 4;
}

/** Theming */

.vscode-light pre {
	background-color: rgba(220, 220, 220, 0.4);
}

.vscode-dark pre {
	background-color: rgba(10, 10, 10, 0.4);
}

.vscode-high-contrast pre {
	background-color: rgb(0, 0, 0);
}

.vscode-high-contrast h1 {
	border-color: rgb(0, 0, 0);
}

.vscode-light table > thead > tr > th {
	border-color: rgba(0, 0, 0, 0.69);
}

.vscode-dark table > thead > tr > th {
	border-color: rgba(255, 255, 255, 0.69);
}

.vscode-light h1,
.vscode-light hr,
.vscode-light table > tbody > tr + tr > td {
	border-color: rgba(0, 0, 0, 0.18);
}

.vscode-dark h1,
.vscode-dark hr,
.vscode-dark table > tbody > tr + tr > td {
	border-color: rgba(255, 255, 255, 0.18);
}

</style>

<style>
/* Tomorrow Theme */
/* http://jmblog.github.com/color-themes-for-google-code-highlightjs */
/* Original theme - https://github.com/chriskempson/tomorrow-theme */

/* Tomorrow Comment */
.hljs-comment,
.hljs-quote {
	color: #8e908c;
}

/* Tomorrow Red */
.hljs-variable,
.hljs-template-variable,
.hljs-tag,
.hljs-name,
.hljs-selector-id,
.hljs-selector-class,
.hljs-regexp,
.hljs-deletion {
	color: #c82829;
}

/* Tomorrow Orange */
.hljs-number,
.hljs-built_in,
.hljs-builtin-name,
.hljs-literal,
.hljs-type,
.hljs-params,
.hljs-meta,
.hljs-link {
	color: #f5871f;
}

/* Tomorrow Yellow */
.hljs-attribute {
	color: #eab700;
}

/* Tomorrow Green */
.hljs-string,
.hljs-symbol,
.hljs-bullet,
.hljs-addition {
	color: #718c00;
}

/* Tomorrow Blue */
.hljs-title,
.hljs-section {
	color: #4271ae;
}

/* Tomorrow Purple */
.hljs-keyword,
.hljs-selector-tag {
	color: #8959a8;
}

.hljs {
	display: block;
	overflow-x: auto;
	color: #4d4d4c;
	padding: 0.5em;
}

.hljs-emphasis {
	font-style: italic;
}

.hljs-strong {
	font-weight: bold;
}
</style>

<style>
/*
 * Markdown PDF CSS
 */

 body {
	font-family: -apple-system, BlinkMacSystemFont, "Segoe WPC", "Segoe UI", "Ubuntu", "Droid Sans", sans-serif, "Meiryo";
	padding: 0 12px;
}

pre {
	background-color: #f8f8f8;
	border: 1px solid #cccccc;
	border-radius: 3px;
	overflow-x: auto;
	white-space: pre-wrap;
	overflow-wrap: break-word;
}

pre:not(.hljs) {
	padding: 23px;
	line-height: 19px;
}

blockquote {
	background: rgba(127, 127, 127, 0.1);
	border-color: rgba(0, 122, 204, 0.5);
}

.emoji {
	height: 1.4em;
}

code {
	font-size: 14px;
	line-height: 19px;
}

/* for inline code */
:not(pre):not(.hljs) > code {
	color: #C9AE75; /* Change the old color so it seems less like an error */
	font-size: inherit;
}

/* Page Break : use <div class="page"/> to insert page break
-------------------------------------------------------- */
.page {
	page-break-after: always;
}

</style>

<script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>
</head>
<body>
  <script>
    mermaid.initialize({
      startOnLoad: true,
      theme: document.body.classList.contains('vscode-dark') || document.body.classList.contains('vscode-high-contrast')
          ? 'dark'
          : 'default'
    });
  </script>
<h1 id="multi-project-docker-health-monitor">Multi-Project Docker Health Monitor</h1>
<p>A robust, production-ready Docker container health monitoring system that tracks containers across multiple projects and sends intelligent email alerts when issues are detected.</p>
<h2 id="quickstart-guide">Quickstart Guide</h2>
<p>Get your entire monitoring system up and running in 15 minutes.</p>
<h3 id="prerequisites-check">Prerequisites Check</h3>
<pre class="hljs"><code><div><span class="hljs-comment"># Verify you have the requirements</span>
python3 --version  <span class="hljs-comment"># Should be 3.7+</span>
docker --version   <span class="hljs-comment"># Should be 19.03+</span>
docker ps          <span class="hljs-comment"># Should list running containers</span>

<span class="hljs-comment"># Verify you have SMTP credentials ready</span>
<span class="hljs-comment"># - SMTP server hostname</span>
<span class="hljs-comment"># - SMTP port (usually 587 or 465)</span>
<span class="hljs-comment"># - Username/email</span>
<span class="hljs-comment"># - Password (or app password for Gmail)</span>
</div></code></pre>
<h3 id="step-1-set-up-the-monitor-5-minutes">Step 1: Set Up the Monitor (5 minutes)</h3>
<p><strong>On your Ubuntu server:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment"># 1. Create monitoring directory</span>
sudo mkdir -p /srv/repos/_docker_monitoring/logs
<span class="hljs-built_in">cd</span> /srv/repos/_docker_monitoring

<span class="hljs-comment"># 2. Download the monitor script</span>
<span class="hljs-comment"># (Upload docker_health_monitor.py to this directory via SCP, Git, or copy-paste)</span>
wget https://your-repo/docker_health_monitor.py
<span class="hljs-comment"># OR</span>
scp docker_health_monitor.py user@server:/srv/repos/_docker_monitoring/

<span class="hljs-comment"># 3. Make it executable</span>
chmod +x docker_health_monitor.py

<span class="hljs-comment"># 4. Install Python dependencies</span>
pip3 install docker python-decouple

<span class="hljs-comment"># 5. Create .env configuration</span>
cat &gt; .env &lt;&lt; <span class="hljs-string">'EOF'</span>
<span class="hljs-comment"># SMTP Configuration</span>
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password

<span class="hljs-comment"># Alert Recipients</span>
HEALTH_CHECK_ALERT_EMAILS=admin@example.com,ops@example.com

<span class="hljs-comment"># Server Identification</span>
SERVER_NAME=Production Server

<span class="hljs-comment"># Monitoring Intervals (adjust as needed)</span>
HEALTH_CHECK_INTERVAL_SEC=30
WAIT_AND_CHECK_AGAIN_MIN=15
HEALTH_CHECK_LOG_LINES=50
EOF

<span class="hljs-comment"># 6. Edit .env with your actual credentials</span>
vim .env
<span class="hljs-comment"># Press 'i' to edit, update values, then ESC + :wq to save</span>

<span class="hljs-comment"># 7. Test the configuration</span>
python3 -c <span class="hljs-string">"from decouple import config; print('SMTP:', config('SMTP_HOST')); print('Emails:', config('HEALTH_CHECK_ALERT_EMAILS'))"</span>
</div></code></pre>
<h3 id="step-2-add-healthchecks-to-your-projects-5-minutes-per-project">Step 2: Add Healthchecks to Your Projects (5 minutes per project)</h3>
<p>For <strong>each</strong> of your Docker projects (e.g., <code>passage_plan</code>, <code>vessel_certificates</code>, <code>hot_works_alerts</code>):</p>
<pre class="hljs"><code><div><span class="hljs-comment"># Navigate to project directory</span>
<span class="hljs-built_in">cd</span> /srv/repos/passage_plan  <span class="hljs-comment"># Or your project path</span>

<span class="hljs-comment"># Create scripts directory if it doesn't exist</span>
mkdir -p scripts

<span class="hljs-comment"># Create healthcheck.py</span>
cat &gt; scripts/healthcheck.py &lt;&lt; <span class="hljs-string">'EOFHC'</span>
<span class="hljs-comment">#!/usr/bin/env python3</span>
<span class="hljs-string">""</span><span class="hljs-string">"
Healthcheck script for Docker containers with flexible scheduling.
Supports both SCHEDULE_FREQUENCY_HOURS and SCHEDULE_TIMES modes.

This script checks if /app/logs/health_status.txt exists, contains "</span>OK<span class="hljs-string">",
and has been updated recently enough based on the schedule configuration.

Environment Variables:
    SCHEDULE_FREQUENCY_HOURS: Run every N hours (e.g., "</span>2<span class="hljs-string">" for every 2 hours)
    SCHEDULE_TIMES: Run at specific times (e.g., "</span>12:00,18:00<span class="hljs-string">")

At least one must be set. If both are set, SCHEDULE_FREQUENCY_HOURS takes precedence.

Exit Codes:
    0: Healthy
    1: Unhealthy
"</span><span class="hljs-string">""</span>
import os
import sys
from datetime import datetime, timedelta
from pathlib import Path
from zoneinfo import ZoneInfo


def main():
    <span class="hljs-string">""</span><span class="hljs-string">"
    Main healthcheck logic.

    Validates the health_status.txt file by checking:
    1. File exists
    2. File contains valid structured data
    3. Status is OK or ERROR is recent
    4. Timestamp is recent enough based on schedule

    Exit codes:
        0: Healthy
        1: Unhealthy
    "</span><span class="hljs-string">""</span>
    health_file = Path(<span class="hljs-string">"/app/logs/health_status.txt"</span>)

    <span class="hljs-comment"># Validate file structure first</span>
    try:
        validate_health_file_structure(health_file)
    except Exception as e:
        <span class="hljs-built_in">print</span>(f<span class="hljs-string">"Health file validation failed: {e}"</span>, file=sys.stderr)
        sys.exit(1)

    <span class="hljs-comment"># Read and parse health status</span>
    try:
        health_data = parse_health_file(health_file)
    except Exception as e:
        <span class="hljs-built_in">print</span>(f<span class="hljs-string">"Cannot parse health status: {e}"</span>, file=sys.stderr)
        sys.exit(1)

    <span class="hljs-comment"># Get the timezone to use for time calculations</span>
    tz_name = get_effective_timezone()

    <span class="hljs-comment"># Calculate maximum age based on schedule mode</span>
    max_age_minutes = calculate_max_age()

    <span class="hljs-comment"># Calculate file age using the parsed timestamp (timezone-aware)</span>
    try:
        now = datetime.now(tz=ZoneInfo(tz_name))
        file_age_seconds = (now - health_data[<span class="hljs-string">'timestamp'</span>]).total_seconds()
        file_age_minutes = file_age_seconds / 60
    except Exception as e:
        <span class="hljs-built_in">print</span>(f<span class="hljs-string">"Cannot calculate file age: {e}"</span>, file=sys.stderr)
        sys.exit(1)

    <span class="hljs-comment"># Check status and age</span>
    <span class="hljs-keyword">if</span> health_data[<span class="hljs-string">'status'</span>] == <span class="hljs-string">"ERROR"</span>:
        <span class="hljs-comment"># For ERROR status, check if it's a recent error</span>
        <span class="hljs-keyword">if</span> file_age_minutes &gt; max_age_minutes:
            <span class="hljs-built_in">print</span>(
                f<span class="hljs-string">"Health status is ERROR and stale: {file_age_minutes:.1f} minutes old "</span>
                f<span class="hljs-string">"(max: {max_age_minutes:.1f} minutes). "</span>
                f<span class="hljs-string">"Error: {health_data.get('error_msg', 'No error message')}"</span>,
                file=sys.stderr
            )
            sys.exit(1)
        <span class="hljs-keyword">else</span>:
            <span class="hljs-comment"># Recent error - still fail but with different message</span>
            <span class="hljs-built_in">print</span>(
                f<span class="hljs-string">"Health status is ERROR (recent): {health_data.get('error_msg', 'No error message')}"</span>,
                file=sys.stderr
            )
            sys.exit(1)

    <span class="hljs-keyword">elif</span> health_data[<span class="hljs-string">'status'</span>] == <span class="hljs-string">"OK"</span>:
        <span class="hljs-comment"># Check if OK status is recent enough</span>
        <span class="hljs-keyword">if</span> file_age_minutes &gt; max_age_minutes:
            <span class="hljs-built_in">print</span>(
                f<span class="hljs-string">"Health status file is too old: {file_age_minutes:.1f} minutes "</span>
                f<span class="hljs-string">"(max: {max_age_minutes:.1f} minutes)"</span>,
                file=sys.stderr
            )
            sys.exit(1)

    <span class="hljs-keyword">else</span>:
        <span class="hljs-built_in">print</span>(f<span class="hljs-string">"Unknown health status: {health_data['status']}"</span>, file=sys.stderr)
        sys.exit(1)

    <span class="hljs-comment"># All checks passed</span>
    <span class="hljs-built_in">print</span>(
        f<span class="hljs-string">"Healthy (status: {health_data['status']}, "</span>
        f<span class="hljs-string">"alert: {health_data.get('alert_type', 'unknown')}, "</span>
        f<span class="hljs-string">"age: {file_age_minutes:.1f}/{max_age_minutes:.1f} minutes)"</span>
    )
    sys.exit(0)


def parse_health_file(health_file: Path) -&gt; dict:
    <span class="hljs-string">""</span><span class="hljs-string">"
    Parse the structured health status file.

    Expected format:
        Line 1: STATUS YYYY-MM-DDTHH:MM:SS.ffffff+HH:MM
        Line 2: ALERT_TYPE: ClassName
        Line 3: TIMEZONE: timezone_name
        Line 4: ERROR_MSG: message (optional, only if ERROR)

    Args:
        health_file: Path to health_status.txt

    Returns:
        Dictionary with parsed health data:
            - status: "</span>OK<span class="hljs-string">" or "</span>ERROR<span class="hljs-string">"
            - timestamp: timezone-aware datetime object
            - alert_type: Alert class name
            - timezone: Timezone name from file
            - error_msg: Error message (only if status is ERROR)

    Raises:
        ValueError: If file format is invalid
        Exception: If file cannot be read or parsed
    "</span><span class="hljs-string">""</span>
    content = health_file.read_text().strip()
    lines = content.split(<span class="hljs-string">'\n'</span>)

    <span class="hljs-keyword">if</span> len(lines) &lt; 3:
        raise ValueError(f<span class="hljs-string">"Health file has insufficient lines: {len(lines)} (expected at least 3)"</span>)

    <span class="hljs-comment"># Parse line 1: STATUS TIMESTAMP</span>
    status_line = lines[0].strip()
    parts = status_line.split(<span class="hljs-string">' '</span>, 1)

    <span class="hljs-keyword">if</span> len(parts) != 2:
        raise ValueError(f<span class="hljs-string">"Invalid status line format: '{status_line}'"</span>)

    status = parts[0]
    timestamp_str = parts[1]

    <span class="hljs-keyword">if</span> status not <span class="hljs-keyword">in</span> [<span class="hljs-string">"OK"</span>, <span class="hljs-string">"ERROR"</span>]:
        raise ValueError(f<span class="hljs-string">"Invalid status: '{status}' (expected OK or ERROR)"</span>)

    <span class="hljs-comment"># Parse timestamp (ISO format with timezone)</span>
    try:
        timestamp = datetime.fromisoformat(timestamp_str)
    except ValueError as e:
        raise ValueError(f<span class="hljs-string">"Invalid timestamp format: '{timestamp_str}': {e}"</span>)

    <span class="hljs-comment"># Ensure timestamp is timezone-aware</span>
    <span class="hljs-keyword">if</span> timestamp.tzinfo is None:
        raise ValueError(f<span class="hljs-string">"Timestamp is not timezone-aware: '{timestamp_str}'"</span>)

    <span class="hljs-comment"># Parse line 2: ALERT_TYPE</span>
    <span class="hljs-keyword">if</span> not lines[1].startswith(<span class="hljs-string">"ALERT_TYPE: "</span>):
        raise ValueError(f<span class="hljs-string">"Invalid ALERT_TYPE line: '{lines[1]}'"</span>)
    alert_type = lines[1].replace(<span class="hljs-string">"ALERT_TYPE: "</span>, <span class="hljs-string">""</span>).strip()

    <span class="hljs-comment"># Parse line 3: TIMEZONE</span>
    <span class="hljs-keyword">if</span> not lines[2].startswith(<span class="hljs-string">"TIMEZONE: "</span>):
        raise ValueError(f<span class="hljs-string">"Invalid TIMEZONE line: '{lines[2]}'"</span>)
    timezone = lines[2].replace(<span class="hljs-string">"TIMEZONE: "</span>, <span class="hljs-string">""</span>).strip()

    result = {
        <span class="hljs-string">'status'</span>: status,
        <span class="hljs-string">'timestamp'</span>: timestamp,
        <span class="hljs-string">'alert_type'</span>: alert_type,
        <span class="hljs-string">'timezone'</span>: timezone
    }

    <span class="hljs-comment"># Parse line 4 (optional): ERROR_MSG</span>
    <span class="hljs-keyword">if</span> len(lines) &gt;= 4 and lines[3].startswith(<span class="hljs-string">"ERROR_MSG: "</span>):
        error_msg = lines[3].replace(<span class="hljs-string">"ERROR_MSG: "</span>, <span class="hljs-string">""</span>).strip()
        result[<span class="hljs-string">'error_msg'</span>] = error_msg

    <span class="hljs-built_in">return</span> result


def get_effective_timezone() -&gt; str:
    <span class="hljs-string">""</span><span class="hljs-string">"
    Determine which timezone to use for time calculations.

    Precedence:
        1. SCHEDULE_TIMES_TIMEZONE (if set)
        2. TIMEZONE (if set)
        3. UTC (default fallback)

    Returns:
        Timezone name (e.g., "</span>Europe/Athens<span class="hljs-string">", "</span>UTC<span class="hljs-string">")
    "</span><span class="hljs-string">""</span>
    schedule_tz = os.getenv(<span class="hljs-string">'SCHEDULE_TIMES_TIMEZONE'</span>, <span class="hljs-string">''</span>).strip()
    <span class="hljs-keyword">if</span> schedule_tz:
        <span class="hljs-built_in">return</span> schedule_tz

    general_tz = os.getenv(<span class="hljs-string">'TIMEZONE'</span>, <span class="hljs-string">''</span>).strip()
    <span class="hljs-keyword">if</span> general_tz:
        <span class="hljs-built_in">return</span> general_tz

    <span class="hljs-built_in">return</span> <span class="hljs-string">'UTC'</span>


def validate_health_file_structure(health_file: Path) -&gt; None:
    <span class="hljs-string">""</span><span class="hljs-string">"
    Perform initial validation of health file structure before parsing.

    Raises:
        FileNotFoundError: If file doesn't exist
        ValueError: If file is empty or has invalid structure
    "</span><span class="hljs-string">""</span>
    <span class="hljs-keyword">if</span> not health_file.exists():
        raise FileNotFoundError(f<span class="hljs-string">"Health file not found: {health_file}"</span>)

    <span class="hljs-built_in">stat</span> = health_file.stat()
    <span class="hljs-keyword">if</span> stat.st_size == 0:
        raise ValueError(<span class="hljs-string">"Health file is empty"</span>)

    <span class="hljs-keyword">if</span> stat.st_size &gt; 10000:  <span class="hljs-comment"># 10KB limit</span>
        raise ValueError(f<span class="hljs-string">"Health file is too large: {stat.st_size} bytes (max 10KB)"</span>)


def calculate_max_age() -&gt; <span class="hljs-built_in">float</span>:
    <span class="hljs-string">""</span><span class="hljs-string">"
    Calculate maximum allowed age for health_status.txt based on schedule mode.

    Returns:
        Maximum age in minutes
    "</span><span class="hljs-string">""</span>
    freq_hours = os.getenv(<span class="hljs-string">'SCHEDULE_FREQUENCY_HOURS'</span>, <span class="hljs-string">''</span>).strip()
    schedule_times = os.getenv(<span class="hljs-string">'SCHEDULE_TIMES'</span>, <span class="hljs-string">''</span>).strip()

    <span class="hljs-comment"># Mode 1: Frequency-based (e.g., every 2 hours)</span>
    <span class="hljs-keyword">if</span> freq_hours:
        try:
            hours = <span class="hljs-built_in">float</span>(freq_hours)
            <span class="hljs-comment"># Allow schedule interval + 10 minute buffer</span>
            <span class="hljs-built_in">return</span> hours * 60 + 10
        except (ValueError, TypeError):
            <span class="hljs-built_in">print</span>(f<span class="hljs-string">"Invalid SCHEDULE_FREQUENCY_HOURS: {freq_hours}"</span>, file=sys.stderr)
            <span class="hljs-built_in">return</span> 70  <span class="hljs-comment"># Default fallback: 1 hour + 10 min buffer</span>

    <span class="hljs-comment"># Mode 2: Specific times (e.g., 12:00,18:00)</span>
    <span class="hljs-keyword">elif</span> schedule_times:
        try:
            <span class="hljs-built_in">return</span> calculate_max_age_from_times(schedule_times)
        except Exception as e:
            <span class="hljs-built_in">print</span>(f<span class="hljs-string">"Error calculating age from SCHEDULE_TIMES: {e}"</span>, file=sys.stderr)
            <span class="hljs-built_in">return</span> 70  <span class="hljs-comment"># Default fallback</span>

    <span class="hljs-comment"># Mode 3: No schedule defined (default to hourly + buffer)</span>
    <span class="hljs-keyword">else</span>:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"Warning: Neither SCHEDULE_FREQUENCY_HOURS nor SCHEDULE_TIMES set"</span>, file=sys.stderr)
        <span class="hljs-built_in">return</span> 70  <span class="hljs-comment"># 1 hour + 10 minute buffer</span>


def calculate_max_age_from_times(schedule_times: str) -&gt; <span class="hljs-built_in">float</span>:
    <span class="hljs-string">""</span><span class="hljs-string">"
    Calculate maximum age based on SCHEDULE_TIMES.

    For times like "</span>12:00,18:00<span class="hljs-string">", the health file should be updated within
    10 minutes after the most recent scheduled time.

    Uses the effective timezone (SCHEDULE_TIMES_TIMEZONE or TIMEZONE) for
    determining "</span>now<span class="hljs-string">" and calculating schedule times.

    Args:
        schedule_times: Comma-separated list of times (HH:MM format)

    Returns:
        Maximum age in minutes (time since most recent scheduled time + 10 min buffer)

    Note:
        This function uses timezone-aware datetime calculations to ensure
        correct behavior across different timezones.
    "</span><span class="hljs-string">""</span>
    <span class="hljs-comment"># Get timezone-aware "now"</span>
    tz_name = get_effective_timezone()
    try:
        now = datetime.now(tz=ZoneInfo(tz_name))
    except Exception as e:
        <span class="hljs-built_in">print</span>(f<span class="hljs-string">"Invalid timezone '{tz_name}': {e}, falling back to UTC"</span>, file=sys.stderr)
        now = datetime.now(tz=ZoneInfo(<span class="hljs-string">'UTC'</span>))

    <span class="hljs-comment"># Parse all scheduled times</span>
    time_list = [t.strip() <span class="hljs-keyword">for</span> t <span class="hljs-keyword">in</span> schedule_times.split(<span class="hljs-string">','</span>)]
    scheduled_datetimes = []

    <span class="hljs-keyword">for</span> time_str <span class="hljs-keyword">in</span> time_list:
        try:
            hour, minute = map(int, time_str.split(<span class="hljs-string">':'</span>))

            <span class="hljs-comment"># Create timezone-aware datetime for today</span>
            scheduled_today = now.replace(hour=hour, minute=minute, second=0, microsecond=0)
            scheduled_datetimes.append(scheduled_today)

            <span class="hljs-comment"># Also consider yesterday's schedule</span>
            scheduled_yesterday = scheduled_today - timedelta(days=1)
            scheduled_datetimes.append(scheduled_yesterday)

        except (ValueError, IndexError) as e:
            <span class="hljs-built_in">print</span>(f<span class="hljs-string">"Invalid time format '{time_str}': {e}"</span>, file=sys.stderr)
            <span class="hljs-built_in">continue</span>

    <span class="hljs-keyword">if</span> not scheduled_datetimes:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"No valid times found in SCHEDULE_TIMES"</span>, file=sys.stderr)
        <span class="hljs-built_in">return</span> 70

    <span class="hljs-comment"># Find the most recent scheduled time that has passed</span>
    past_times = [dt <span class="hljs-keyword">for</span> dt <span class="hljs-keyword">in</span> scheduled_datetimes <span class="hljs-keyword">if</span> dt &lt;= now]

    <span class="hljs-keyword">if</span> not past_times:
        <span class="hljs-comment"># No scheduled time has passed yet today - use most recent from yesterday</span>
        past_times = sorted(scheduled_datetimes)

    most_recent = max(past_times)

    <span class="hljs-comment"># Calculate minutes since most recent scheduled time</span>
    minutes_since = (now - most_recent).total_seconds() / 60

    <span class="hljs-comment"># Allow the time since last schedule + 10 minute buffer</span>
    <span class="hljs-built_in">return</span> minutes_since + 10


<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    main()
EOFHC

<span class="hljs-comment"># Make it executable</span>
chmod +x scripts/healthcheck.py
</div></code></pre>
<h3 id="step-3-update-dockerfiles-2-minutes-per-project">Step 3: Update Dockerfiles (2 minutes per project)</h3>
<p>For each project, add healthcheck to your Dockerfile:</p>
<pre class="hljs"><code><div><span class="hljs-comment"># Edit your Dockerfile</span>
vim Dockerfile
</div></code></pre>
<p>Add these lines <strong>after</strong> your <code>COPY</code> commands but <strong>before</strong> <code>CMD</code>:</p>
<pre class="hljs"><code><div><span class="hljs-comment"># Ensure scripts are copied (if not already)</span>
<span class="hljs-keyword">COPY</span><span class="bash"> scripts/ ./scripts/</span>

<span class="hljs-comment"># Make healthcheck executable</span>
<span class="hljs-keyword">RUN</span><span class="bash"> chmod +x /app/scripts/*.py</span>

<span class="hljs-comment"># Add healthcheck - choose interval based on your schedule</span>
<span class="hljs-comment"># For SCHEDULE_TIMES (e.g., 12:00,18:00):</span>
<span class="hljs-keyword">HEALTHCHECK</span><span class="bash"> --interval=5m --timeout=10s --start-period=2m --retries=2 \
  CMD python3 /app/scripts/healthcheck.py</span>

<span class="hljs-comment"># For SCHEDULE_FREQUENCY_HOURS=1 (hourly):</span>
<span class="hljs-comment"># HEALTHCHECK --interval=2m --timeout=10s --start-period=2m --retries=2 \</span>
<span class="hljs-comment">#   CMD python3 /app/scripts/healthcheck.py</span>

<span class="hljs-comment"># For SCHEDULE_FREQUENCY_HOURS=0.25 (every 15 min):</span>
<span class="hljs-comment"># HEALTHCHECK --interval=1m --timeout=10s --start-period=1m --retries=3 \</span>
<span class="hljs-comment">#   CMD python3 /app/scripts/healthcheck.py</span>
</div></code></pre>
<p><strong>Choose the right interval:</strong></p>
<ul>
<li>If using <code>SCHEDULE_TIMES=12:00,18:00</code> → <code>--interval=5m</code></li>
<li>If using <code>SCHEDULE_FREQUENCY_HOURS=1</code> → <code>--interval=2m</code></li>
<li>If using <code>SCHEDULE_FREQUENCY_HOURS=0.25</code> → <code>--interval=1m</code></li>
</ul>
<h3 id="step-4-rebuild-and-restart-containers-2-minutes-per-project">Step 4: Rebuild and Restart Containers (2 minutes per project)</h3>
<pre class="hljs"><code><div><span class="hljs-comment"># Still in project directory (e.g., /srv/repos/passage_plan)</span>

<span class="hljs-comment"># Rebuild the image</span>
docker compose build

<span class="hljs-comment"># Restart containers</span>
docker compose up -d

<span class="hljs-comment"># Verify healthcheck is working</span>
docker ps
<span class="hljs-comment"># You should see "healthy" or "starting" in the STATUS column</span>

<span class="hljs-comment"># Check detailed health status</span>
docker inspect &lt;container-name&gt; | grep -A 20 Health

<span class="hljs-comment"># Test healthcheck manually</span>
docker <span class="hljs-built_in">exec</span> &lt;container-name&gt; python3 /app/scripts/healthcheck.py
<span class="hljs-comment"># Expected output: Healthy (status: OK, alert: AlertClassName, age: X/Y minutes)</span>

<span class="hljs-comment"># Check the health file directly</span>
docker <span class="hljs-built_in">exec</span> &lt;container-name&gt; cat /app/logs/health_status.txt
<span class="hljs-comment"># Should show structured format with OK/ERROR, timestamp, alert type, timezone</span>

<span class="hljs-comment"># Verify environment variables</span>
docker <span class="hljs-built_in">exec</span> &lt;container-name&gt; env | grep SCHEDULE
<span class="hljs-comment"># Should show SCHEDULE_FREQUENCY_HOURS or SCHEDULE_TIMES</span>
</div></code></pre>
<p><strong>Repeat Step 2-4 for each project:</strong></p>
<ul>
<li><code>/srv/repos/passage_plan</code></li>
<li><code>/srv/repos/vessel_certificates</code></li>
<li><code>/srv/repos/hot_works_alerts</code></li>
<li>Any other projects</li>
</ul>
<h3 id="step-5-set-up-monitor-as-system-service-3-minutes">Step 5: Set Up Monitor as System Service (3 minutes)</h3>
<pre class="hljs"><code><div><span class="hljs-comment"># Create systemd service file</span>
sudo vim /etc/systemd/system/docker-health-monitor.service
</div></code></pre>
<p>Paste this content:</p>
<pre class="hljs"><code><div><span class="hljs-section">[Unit]</span>
<span class="hljs-attr">Description</span>=Multi-Project Docker Health Monitor
<span class="hljs-attr">After</span>=docker.service
<span class="hljs-attr">Requires</span>=docker.service

<span class="hljs-section">[Service]</span>
<span class="hljs-attr">Type</span>=simple
<span class="hljs-attr">User</span>=root
<span class="hljs-attr">WorkingDirectory</span>=/srv/repos/_docker_monitoring
<span class="hljs-attr">ExecStart</span>=/usr/bin/python3 /srv/repos/_docker_monitoring/docker_health_monitor.py
<span class="hljs-attr">Restart</span>=always
<span class="hljs-attr">RestartSec</span>=<span class="hljs-number">10</span>
<span class="hljs-attr">StandardOutput</span>=journal
<span class="hljs-attr">StandardError</span>=journal

<span class="hljs-section">[Install]</span>
<span class="hljs-attr">WantedBy</span>=multi-user.target
</div></code></pre>
<p><strong>If running as non-root user:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment"># Add your user to docker group</span>
sudo usermod -aG docker your-username

<span class="hljs-comment"># Then change User=root to User=your-username in service file</span>
</div></code></pre>
<p><strong>Enable and start the service:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment"># Reload systemd</span>
sudo systemctl daemon-reload

<span class="hljs-comment"># Enable (start on boot)</span>
sudo systemctl <span class="hljs-built_in">enable</span> docker-health-monitor

<span class="hljs-comment"># Start now</span>
sudo systemctl start docker-health-monitor

<span class="hljs-comment"># Check status</span>
sudo systemctl status docker-health-monitor
<span class="hljs-comment"># Should show: "active (running)"</span>

<span class="hljs-comment"># View logs</span>
sudo journalctl -u docker-health-monitor -f
<span class="hljs-comment"># Press Ctrl+C to exit</span>
</div></code></pre>
<h3 id="step-6-verify-everything-works-5-minutes">Step 6: Verify Everything Works (5 minutes)</h3>
<p><strong>1. Check monitor logs:</strong></p>
<pre class="hljs"><code><div>tail -f /srv/repos/_docker_monitoring/logs/monitor.log
</div></code></pre>
<p>You should see:</p>
<pre class="hljs"><code><div>======================================================================
▶ MULTI-PROJECT DOCKER HEALTH MONITOR STARTED
======================================================================
</div></code></pre>
<p><strong>2. Check container health statuses:</strong></p>
<pre class="hljs"><code><div>docker ps --format <span class="hljs-string">"table {{.Names}}\t{{.Status}}"</span>
</div></code></pre>
<p>All containers should show <code>healthy</code> or <code>starting</code> (will become healthy after <code>start_period</code>).</p>
<p><strong>3. Test with intentional failure:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment"># Pick one project to test</span>
<span class="hljs-built_in">cd</span> /srv/repos/passage_plan

<span class="hljs-comment"># Break the container (e.g., wrong DB password in .env)</span>
vim .env
<span class="hljs-comment"># Change DB_PASS to something wrong, save</span>

<span class="hljs-comment"># Restart container</span>
docker compose up -d

<span class="hljs-comment"># Watch it become unhealthy</span>
watch -n 5 <span class="hljs-string">'docker ps --format "table {{.Names}}\t{{.Status}}"'</span>
<span class="hljs-comment"># After 2-5 minutes, should show "unhealthy"</span>

<span class="hljs-comment"># Monitor logs - you should see Phase 2 activity after 15 minutes</span>
tail -f /srv/repos/_docker_monitoring/logs/monitor.log

<span class="hljs-comment"># You should receive an email alert after ~15 minutes!</span>

<span class="hljs-comment"># Fix it</span>
vim .env
<span class="hljs-comment"># Restore correct DB_PASS</span>
docker compose up -d

<span class="hljs-comment"># Should become healthy again</span>
</div></code></pre>
<h3 id="testing-healthcheck-failures">Testing Healthcheck Failures</h3>
<p><strong>Method 1: Simulate old timestamp (recommended):</strong></p>
<pre class="hljs"><code><div>docker <span class="hljs-built_in">exec</span> &lt;container-name&gt; python3 &lt;&lt; <span class="hljs-string">'EOF'</span>
from pathlib import Path
from datetime import datetime, timedelta
from zoneinfo import ZoneInfo

health_file = Path(<span class="hljs-string">"/app/logs/health_status.txt"</span>)
old_time = datetime.now(tz=ZoneInfo(<span class="hljs-string">"Europe/Athens"</span>)) - timedelta(hours=2)

with open(health_file, <span class="hljs-string">'w'</span>) as f:
    f.write(f<span class="hljs-string">"OK {old_time.isoformat()}\n"</span>)
    f.write(f<span class="hljs-string">"ALERT_TYPE: YourAlertClassName\n"</span>)
    f.write(f<span class="hljs-string">"TIMEZONE: Europe/Athens\n"</span>)

<span class="hljs-built_in">print</span>(f<span class="hljs-string">"Set timestamp to 2 hours ago"</span>)
EOF

<span class="hljs-comment"># Test healthcheck - should fail</span>
docker <span class="hljs-built_in">exec</span> &lt;container-name&gt; python3 /app/scripts/healthcheck.py
</div></code></pre>
<p><strong>Method 2: Simulate ERROR status:</strong></p>
<pre class="hljs"><code><div>docker <span class="hljs-built_in">exec</span> &lt;container-name&gt; python3 &lt;&lt; <span class="hljs-string">'EOF'</span>
from pathlib import Path
from datetime import datetime
from zoneinfo import ZoneInfo

health_file = Path(<span class="hljs-string">"/app/logs/health_status.txt"</span>)
now = datetime.now(tz=ZoneInfo(<span class="hljs-string">"Europe/Athens"</span>))

with open(health_file, <span class="hljs-string">'w'</span>) as f:
    f.write(f<span class="hljs-string">"ERROR {now.isoformat()}\n"</span>)
    f.write(f<span class="hljs-string">"ALERT_TYPE: YourAlertClassName\n"</span>)
    f.write(f<span class="hljs-string">"TIMEZONE: Europe/Athens\n"</span>)
    f.write(f<span class="hljs-string">"ERROR_MSG: Simulated database failure\n"</span>)
EOF

<span class="hljs-comment"># Test healthcheck - should fail</span>
docker <span class="hljs-built_in">exec</span> &lt;container-name&gt; python3 /app/scripts/healthcheck.py
</div></code></pre>
<h3 id="step-7-optional---configure-project-specific-routing">Step 7: Optional - Configure Project-Specific Routing</h3>
<p>If you want different teams to receive alerts for different projects:</p>
<pre class="hljs"><code><div><span class="hljs-comment"># Edit monitor .env</span>
<span class="hljs-built_in">cd</span> /srv/repos/_docker_monitoring
vim .env
</div></code></pre>
<p>Add this line:</p>
<pre class="hljs"><code><div>CONTAINER_ALERT_ROUTING=passage-plan:maritime-team@example.com;vessel-cert:compliance@example.com;hot-works:safety@example.com
</div></code></pre>
<p>Restart monitor:</p>
<pre class="hljs"><code><div>sudo systemctl restart docker-health-monitor
</div></code></pre>
<h3 id="quick-reference-commands">Quick Reference Commands</h3>
<pre class="hljs"><code><div><span class="hljs-comment"># Monitor status</span>
sudo systemctl status docker-health-monitor

<span class="hljs-comment"># Monitor logs (live)</span>
sudo journalctl -u docker-health-monitor -f
tail -f /srv/repos/_docker_monitoring/logs/monitor.log

<span class="hljs-comment"># Container health statuses</span>
docker ps --format <span class="hljs-string">"table {{.Names}}\t{{.Status}}"</span>

<span class="hljs-comment"># Check specific container healthcheck</span>
docker <span class="hljs-built_in">exec</span> &lt;container-name&gt; python3 /app/scripts/healthcheck.py

<span class="hljs-comment"># Restart monitor</span>
sudo systemctl restart docker-health-monitor

<span class="hljs-comment"># Stop monitor</span>
sudo systemctl stop docker-health-monitor

<span class="hljs-comment"># View monitor configuration</span>
cat /srv/repos/_docker_monitoring/.env
</div></code></pre>
<h3 id="troubleshooting-quick-fixes">Troubleshooting Quick Fixes</h3>
<p><strong>Container shows &quot;starting&quot; forever:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment"># Increase start_period in Dockerfile</span>
HEALTHCHECK --start-period=5m ...
docker compose build &amp;&amp; docker compose up -d
</div></code></pre>
<p><strong>Monitor not starting:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment"># Check configuration</span>
python3 -c <span class="hljs-string">"from decouple import config; print(config('SMTP_HOST'))"</span>

<span class="hljs-comment"># Check Docker permissions</span>
docker ps

<span class="hljs-comment"># Check service logs</span>
sudo journalctl -u docker-health-monitor -n 50
</div></code></pre>
<p><strong>No emails arriving:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment"># Test SMTP</span>
<span class="hljs-built_in">cd</span> /srv/repos/_docker_monitoring
python3 &lt;&lt; <span class="hljs-string">'EOF'</span>
import smtplib
from decouple import config

server = smtplib.SMTP(config(<span class="hljs-string">'SMTP_HOST'</span>), int(config(<span class="hljs-string">'SMTP_PORT'</span>, 587)))
server.starttls()
server.login(config(<span class="hljs-string">'SMTP_USER'</span>), config(<span class="hljs-string">'SMTP_PASS'</span>))
<span class="hljs-built_in">print</span>(<span class="hljs-string">'✓ SMTP works'</span>)
server.quit()
EOF
</div></code></pre>
<h3 id="success-checklist">Success Checklist</h3>
<ul>
<li><input type="checkbox" id="checkbox0"><label for="checkbox0">Monitor service running: </label><code>systemctl status docker-health-monitor</code></li>
<li><input type="checkbox" id="checkbox1"><label for="checkbox1">All containers show &quot;healthy&quot;: </label><code>docker ps</code></li>
<li><input type="checkbox" id="checkbox2"><label for="checkbox2">Monitor logs show activity: </label><code>tail -f logs/monitor.log</code></li>
<li><input type="checkbox" id="checkbox3"><label for="checkbox3">Test email received (after breaking a container)</label></li>
<li><input type="checkbox" id="checkbox4"><label for="checkbox4">All projects have healthcheck.py</label></li>
<li><input type="checkbox" id="checkbox5"><label for="checkbox5">All Dockerfiles have HEALTHCHECK line</label></li>
<li><input type="checkbox" id="checkbox6"><label for="checkbox6">.env configured with correct SMTP settings</label></li>
</ul>
<p>** Your monitoring system is now active and will alert you of any container issues.**</p>
<hr>
<h2 id="overview">Overview</h2>
<p>This monitor watches all Docker containers with healthchecks across multiple docker-compose projects, implements a two-phase verification pattern to avoid false positives, and sends contextual email alerts with actionable troubleshooting steps.</p>
<p><strong>Key Features:</strong></p>
<ul>
<li><strong>Two-phase health verification</strong> - confirms issues before alerting</li>
<li><strong>Concurrent health checks</strong> using ThreadPoolExecutor (30 workers)</li>
<li><strong>Project-aware alerting</strong> - groups containers by project with context</li>
<li><strong>Thread-safe</strong> state management</li>
<li><strong>Graceful shutdown</strong> handling for clean stops</li>
<li><strong>Zero false positives</strong> - only alerts after confirmation</li>
<li><strong>Scales efficiently</strong> to any number of containers</li>
<li><strong>Cross-platform</strong> - works on Mac, Ubuntu, and other Linux distributions</li>
</ul>
<h2 id="architecture">Architecture</h2>
<h3 id="high-level-two-phase-flow">High-Level Two-Phase Flow</h3>
<pre><code class="language-mermaid"><div class="mermaid">flowchart TD
    Start([Monitor Starts]) --> Init[Initialize Monitor<br/>Load Config from .env]
    Init --> StartLoop[Start Main Loop]
    
    StartLoop --> MainLoop{Shutdown<br/>Requested?}
    
    MainLoop -->|No| Phase1[Phase 1: Check All Containers<br/>Concurrent Health Checks]
    MainLoop -->|Yes| Shutdown([Graceful Shutdown])
    
    Phase1 --> GetContainers[Get All Running Containers<br/>from Docker API]
    
    GetContainers --> SubmitChecks[Submit Health Checks<br/>to Thread Pool<br/>Max 30 Concurrent]
    
    SubmitChecks --> C1[Worker: Check Container 1]
    SubmitChecks --> C2[Worker: Check Container 2]
    SubmitChecks --> C3[Worker: Check Container 3]
    SubmitChecks --> Cn[Worker: Check Container N]
    
    C1 --> Result1[Return: ContainerHealthCheck]
    C2 --> Result2[Return: ContainerHealthCheck]
    C3 --> Result3[Return: ContainerHealthCheck]
    Cn --> Resultn[Return: ContainerHealthCheck]
    
    Result1 --> Collect[Collect All Results]
    Result2 --> Collect
    Result3 --> Collect
    Resultn --> Collect
    
    Collect --> Categorize[Categorize Results:<br/>1. Needs Retry<br/>2. Immediate Alerts<br/>3. No Change]
    
    Categorize --> UpdateStates[Update Container States<br/>Thread-Safe]
    
    UpdateStates --> CheckMissing[Check for Disappeared<br/>Containers]
    
    CheckMissing --> Missing{Any Containers<br/>Disappeared?}
    Missing -->|Yes| AlertMissing[Send not_found Alerts<br/>Synchronously]
    Missing -->|No| HandleImmediate
    AlertMissing --> HandleImmediate
    
    HandleImmediate[Handle Immediate Alerts<br/>Recoveries]
    
    HandleImmediate --> Decision{Any Containers<br/>Need Retry?}
    
    Decision -->|No| Sleep[Sleep check_interval_sec<br/>Default: 30 seconds]
    Decision -->|Yes| WaitMsg[Log: Waiting Before Recheck]
    
    WaitMsg --> MainSleep[Main Thread Sleep<br/>wait_and_check_again_min<br/>Default: 15 minutes]
    
    MainSleep --> Phase2[Phase 2: Recheck Unhealthy<br/>Concurrent Rechecks]
    
    Phase2 --> SubmitRechecks[Submit Rechecks<br/>to Thread Pool<br/>Max 30 Concurrent]
    
    SubmitRechecks --> RC1[Worker: Recheck Container X]
    SubmitRechecks --> RC2[Worker: Recheck Container Y]
    SubmitRechecks --> RCn[Worker: Recheck Container Z]
    
    RC1 --> Status1{Still<br/>Unhealthy?}
    RC2 --> Status2{Still<br/>Unhealthy?}
    RCn --> Statusn{Still<br/>Unhealthy?}
    
    Status1 -->|Yes| Alert1[Get Logs<br/>Send Alert Email]
    Status1 -->|No| Log1[Log: Container Recovered]
    
    Status2 -->|Yes| Alert2[Get Logs<br/>Send Alert Email]
    Status2 -->|No| Log2[Log: Container Recovered]
    
    Statusn -->|Yes| Alertn[Get Logs<br/>Send Alert Email]
    Statusn -->|No| Logn[Log: Container Recovered]
    
    Alert1 --> UpdateFinal
    Alert2 --> UpdateFinal
    Alertn --> UpdateFinal
    Log1 --> UpdateFinal
    Log2 --> UpdateFinal
    Logn --> UpdateFinal
    
    UpdateFinal[Update Container States<br/>Mark as Checked]
    
    UpdateFinal --> Sleep
    Sleep --> MainLoop
    
    Shutdown --> WaitThreads[Wait for Active<br/>Thread Pool Tasks]
    WaitThreads --> Stop([Monitor Stopped])
    
    style Phase1 fill:#e1f5ff
    style Phase2 fill:#fff4e1
    style MainSleep fill:#ffe1e1
    style Decision fill:#f0e1ff
    style Sleep fill:#e1ffe1
</div></code></pre>
<h3 id="detailed-phase-1-flow">Detailed Phase 1 Flow</h3>
<pre><code class="language-mermaid"><div class="mermaid">flowchart TD
    Start([Phase 1 Begins]) --> Submit[Submit All Containers<br/>to Thread Pool]
    
    Submit --> Worker[Worker Thread:<br/>check_single_container]
    
    Worker --> GetHealth[Call Docker API<br/>get_container_health]
    
    GetHealth --> HasHealth{Has<br/>Healthcheck?}
    HasHealth -->|No| Skip[Skip Container<br/>Return None]
    HasHealth -->|Yes| GetPrevious[Get Previous State<br/>Thread-Safe Read]
    
    GetPrevious --> Compare{Status<br/>Changed?}
    
    Compare -->|No| JustUpdate[Update last_check<br/>Thread-Safe Write]
    Compare -->|Yes| LogChange[Log Status Change]
    
    LogChange --> WhichChange{What<br/>Changed?}
    
    WhichChange -->|Became Unhealthy| AddRetry[Add to needs_retry List<br/>Return ContainerHealthCheck]
    WhichChange -->|Became Healthy| AddImmediate[Add to immediate_alerts List<br/>Return ContainerHealthCheck]
    WhichChange -->|Other Change| UpdateState[Update State<br/>Return ContainerHealthCheck]
    
    Skip --> End
    JustUpdate --> End
    AddRetry --> End
    AddImmediate --> End
    UpdateState --> End
    
    End([Return to Collector])
    
    style Worker fill:#e1f5ff
    style AddRetry fill:#ffcccc
    style AddImmediate fill:#ccffcc
</div></code></pre>
<h3 id="detailed-phase-2-flow">Detailed Phase 2 Flow</h3>
<pre><code class="language-mermaid"><div class="mermaid">flowchart TD
    Start([Phase 2 Begins]) --> HasRetries{Any Containers<br/>to Recheck?}
    
    HasRetries -->|No| Skip([Skip Phase 2])
    HasRetries -->|Yes| LogWait[Log: Rechecking N containers<br/>after M minutes]
    
    LogWait --> Sleep[Main Thread Sleeps<br/>wait_and_check_again_min × 60 seconds<br/>Interruptible every 1 second]
    
    Sleep --> Submit[Submit Rechecks<br/>to Thread Pool]
    
    Submit --> Worker[Worker Thread:<br/>recheck_single_container]
    
    Worker --> TryGet[Try to Get Container<br/>from Docker API]
    
    TryGet --> Exists{Container<br/>Exists?}
    
    Exists -->|No| ReturnNotFound[Return: not_found Status]
    Exists -->|Yes| GetHealth[Get Current Health Status]
    
    GetHealth --> ReturnStatus[Return: Current Status]
    
    ReturnNotFound --> Collect
    ReturnStatus --> Collect
    
    Collect[Collect All Recheck Results]
    
    Collect --> Process[Process Each Result]
    
    Process --> CheckStatus{Current<br/>Status?}
    
    CheckStatus -->|healthy| LogRecovery[Log: Container Recovered<br/>Update State<br/>No Alert]
    CheckStatus -->|unhealthy| GetLogs[Fetch Container Logs<br/>Last N Lines]
    CheckStatus -->|not_found| PrepareNotFound[Prepare not_found Alert]
    
    GetLogs --> SendAlert[Send Alert Email<br/>with Logs]
    PrepareNotFound --> SendAlert
    
    SendAlert --> UpdateState[Update Container State]
    LogRecovery --> UpdateState
    
    UpdateState --> End([Phase 2 Complete])
    
    style Sleep fill:#ffe1e1
    style SendAlert fill:#ff9999
    style LogRecovery fill:#99ff99
</div></code></pre>
<h3 id="thread-pool-usage-pattern">Thread Pool Usage Pattern</h3>
<pre><code class="language-mermaid"><div class="mermaid">flowchart LR
    Main[Main Thread] --> Loop[Monitoring Loop]
    
    Loop --> Phase1Call[Phase 1: check_all_containers]
    Phase1Call --> Pool[Thread Pool<br/>30 Workers]
    
    Pool --> Check1[check_single_container<br/>Container 1]
    Pool --> Check2[check_single_container<br/>Container 2]
    Pool --> CheckN[check_single_container<br/>Container N]
    
    Check1 --> Docker1[Docker API Call]
    Check2 --> Docker2[Docker API Call]
    CheckN --> DockerN[Docker API Call]
    
    Docker1 --> Return1[Return Result]
    Docker2 --> Return2[Return Result]
    DockerN --> ReturnN[Return Result]
    
    Return1 --> Collect1[Main Thread<br/>Collects Results]
    Return2 --> Collect1
    ReturnN --> Collect1
    
    Collect1 --> MainSleep[Main Thread<br/>Sleeps if Needed]
    
    MainSleep --> Phase2Call[Phase 2: recheck_unhealthy]
    Phase2Call --> Pool
    
    Pool --> Recheck1[recheck_single_container<br/>Container X]
    Pool --> Recheck2[recheck_single_container<br/>Container Y]
    
    Recheck1 --> RDocker1[Docker API Call]
    Recheck2 --> RDocker2[Docker API Call]
    
    RDocker1 --> RReturn1[Return Result]
    RDocker2 --> RReturn2[Return Result]
    
    RReturn1 --> Collect2[Main Thread<br/>Collects Results]
    RReturn2 --> Collect2
    
    Collect2 --> NextLoop[Sleep check_interval_sec]
    NextLoop --> Loop
    
    State[(Container States<br/>Dict - Thread-Safe)]
    
    Check1 -.Read/Write.-> State
    Check2 -.Read/Write.-> State
    CheckN -.Read/Write.-> State
    Recheck1 -.Read.-> State
    Recheck2 -.Read.-> State
    
    style Pool fill:#e1f5ff
    style MainSleep fill:#ffe1e1
    style State fill:#fff4e1
</div></code></pre>
<h2 id="installation">Installation</h2>
<h3 id="prerequisites">Prerequisites</h3>
<ul>
<li>Python 3.7+</li>
<li>Docker Engine with API access</li>
<li>SMTP server credentials for email alerts</li>
</ul>
<h3 id="setup">Setup</h3>
<p><strong>For Ubuntu/Linux:</strong></p>
<pre class="hljs"><code><div>sudo mkdir -p /srv/repos/_docker_monitoring/logs
<span class="hljs-built_in">cd</span> /srv/repos/_docker_monitoring
</div></code></pre>
<p><strong>For Mac/Development:</strong></p>
<pre class="hljs"><code><div>mkdir -p ~/dev/alerts/_docker_monitoring/logs
<span class="hljs-built_in">cd</span> ~/dev/alerts/_docker_monitoring
</div></code></pre>
<p><strong>Common steps:</strong></p>
<ol>
<li>
<p><strong>Download the scripts:</strong></p>
<ul>
<li><code>docker_health_monitor.py</code> (main script)</li>
<li><code>.env</code> (configuration file)</li>
</ul>
</li>
<li>
<p><strong>Install dependencies:</strong></p>
<pre class="hljs"><code><div>pip3 install docker python-decouple
</div></code></pre>
</li>
<li>
<p><strong>Set permissions:</strong></p>
<pre class="hljs"><code><div>chmod +x docker_health_monitor.py
</div></code></pre>
</li>
<li>
<p><strong>Add healthcheck scripts to your projects</strong> (see Container Healthcheck section)</p>
</li>
</ol>
<h2 id="configuration">Configuration</h2>
<p>Create a <code>.env</code> file in the same directory as <code>docker_health_monitor.py</code>:</p>
<pre class="hljs"><code><div><span class="hljs-comment"># ============================================</span>
<span class="hljs-comment"># REQUIRED CONFIGURATION</span>
<span class="hljs-comment"># ============================================</span>

<span class="hljs-comment"># SMTP Configuration</span>
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password

<span class="hljs-comment"># Alert Recipients (comma-separated)</span>
HEALTH_CHECK_ALERT_EMAILS=admin@example.com,ops@example.com

<span class="hljs-comment"># ============================================</span>
<span class="hljs-comment"># OPTIONAL CONFIGURATION</span>
<span class="hljs-comment"># ============================================</span>

<span class="hljs-comment"># Server Identification</span>
SERVER_NAME=Production Server

<span class="hljs-comment"># Monitoring Intervals</span>
HEALTH_CHECK_INTERVAL_SEC=30
WAIT_AND_CHECK_AGAIN_MIN=15

<span class="hljs-comment"># Logging</span>
HEALTH_CHECK_LOG_LINES=50

<span class="hljs-comment"># Project-Specific Alert Routing</span>
<span class="hljs-comment"># Format: pattern1:email1,email2;pattern2:email3</span>
CONTAINER_ALERT_ROUTING=passage-plan:maritime@example.com;vessel-cert:compliance@example.com
</div></code></pre>
<h3 id="configuration-reference">Configuration Reference</h3>
<table>
<thead>
<tr>
<th>Variable</th>
<th>Required</th>
<th>Default</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>SMTP_HOST</code></td>
<td><strong>Yes</strong></td>
<td>-</td>
<td>SMTP server hostname</td>
</tr>
<tr>
<td><code>SMTP_PORT</code></td>
<td>No</td>
<td>587</td>
<td>SMTP server port (587=STARTTLS, 465=SSL)</td>
</tr>
<tr>
<td><code>SMTP_USER</code></td>
<td><strong>Yes</strong></td>
<td>-</td>
<td>SMTP username/email</td>
</tr>
<tr>
<td><code>SMTP_PASS</code></td>
<td><strong>Yes</strong></td>
<td>-</td>
<td>SMTP password or app-specific password</td>
</tr>
<tr>
<td><code>HEALTH_CHECK_ALERT_EMAILS</code></td>
<td><strong>Yes</strong></td>
<td>-</td>
<td>Comma-separated list of default alert recipients</td>
</tr>
<tr>
<td><code>SERVER_NAME</code></td>
<td>No</td>
<td><code>Production</code></td>
<td>Server identifier shown in alert emails</td>
</tr>
<tr>
<td><code>HEALTH_CHECK_INTERVAL_SEC</code></td>
<td>No</td>
<td><code>30</code></td>
<td>Seconds between health check cycles</td>
</tr>
<tr>
<td><code>WAIT_AND_CHECK_AGAIN_MIN</code></td>
<td>No</td>
<td><code>15</code></td>
<td>Minutes to wait before rechecking unhealthy containers</td>
</tr>
<tr>
<td><code>HEALTH_CHECK_LOG_LINES</code></td>
<td>No</td>
<td><code>50</code></td>
<td>Number of log lines to include in alert emails</td>
</tr>
<tr>
<td><code>CONTAINER_ALERT_ROUTING</code></td>
<td>No</td>
<td>-</td>
<td>Project-specific email routing (see below)</td>
</tr>
</tbody>
</table>
<h3 id="smtp-port-configuration">SMTP Port Configuration</h3>
<p><strong>Port 587 (STARTTLS) - Recommended:</strong></p>
<ul>
<li>Most common and widely supported</li>
<li>Uses STARTTLS encryption</li>
<li>Works with Gmail, most email providers</li>
</ul>
<pre class="hljs"><code><div>SMTP_PORT=587
</div></code></pre>
<p><strong>Port 465 (SSL/TLS) - Alternative:</strong></p>
<ul>
<li>Direct SSL connection</li>
<li>Some servers prefer this</li>
<li>May be required for internal SMTP servers</li>
</ul>
<pre class="hljs"><code><div>SMTP_PORT=465
</div></code></pre>
<p>The script automatically detects which method to use based on the port number.</p>
<h3 id="hardcoded-settings">Hardcoded Settings</h3>
<p>These values are <strong>hardcoded in the script</strong> but use relative paths:</p>
<ul>
<li><strong>Log directory:</strong> <code>./logs/</code> (relative to script location)</li>
<li><strong>Log file:</strong> <code>./logs/monitor.log</code></li>
<li><strong>Log file max size:</strong> 10 MB</li>
<li><strong>Log backup count:</strong> 5 files</li>
<li><strong>Thread pool workers:</strong> 30</li>
</ul>
<p>The script automatically creates the <code>logs/</code> directory if it doesn't exist.</p>
<h2 id="container-healthchecks">Container Healthchecks</h2>
<p>Every container must have a healthcheck defined. The monitor <strong>only tracks containers with healthchecks</strong>.</p>
<h3 id="adding-healthchecks-to-your-projects">Adding Healthchecks to Your Projects</h3>
<h4 id="step-1-create-scriptshealthcheckpy-in-each-project">Step 1: Create <code>scripts/healthcheck.py</code> in Each Project</h4>
<p>Create a file at <code>&lt;project&gt;/scripts/healthcheck.py</code>:</p>
<pre class="hljs"><code><div><span class="hljs-comment">#!/usr/bin/env python3</span>
<span class="hljs-string">"""
Healthcheck script for Docker containers with flexible scheduling.
Supports both SCHEDULE_FREQUENCY_HOURS and SCHEDULE_TIMES modes.
"""</span>
<span class="hljs-keyword">import</span> os
<span class="hljs-keyword">import</span> sys
<span class="hljs-keyword">from</span> datetime <span class="hljs-keyword">import</span> datetime, timedelta
<span class="hljs-keyword">from</span> pathlib <span class="hljs-keyword">import</span> Path


<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span><span class="hljs-params">()</span>:</span>
    <span class="hljs-string">"""Main healthcheck logic."""</span>
    health_file = Path(<span class="hljs-string">"/app/logs/health_status.txt"</span>)
    
    <span class="hljs-comment"># Check if health file exists</span>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> health_file.exists():
        print(<span class="hljs-string">"Health status file not found"</span>, file=sys.stderr)
        sys.exit(<span class="hljs-number">1</span>)
    
    <span class="hljs-comment"># Read health status</span>
    <span class="hljs-keyword">try</span>:
        content = health_file.read_text().strip()
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> content.startswith(<span class="hljs-string">"OK"</span>):
            print(<span class="hljs-string">f"Health status is not OK: <span class="hljs-subst">{content}</span>"</span>, file=sys.stderr)
            sys.exit(<span class="hljs-number">1</span>)
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        print(<span class="hljs-string">f"Cannot read health status: <span class="hljs-subst">{e}</span>"</span>, file=sys.stderr)
        sys.exit(<span class="hljs-number">1</span>)
    
    <span class="hljs-comment"># Calculate maximum age based on schedule mode</span>
    max_age_minutes = calculate_max_age()
    
    <span class="hljs-comment"># Check file modification time</span>
    file_age_seconds = datetime.now().timestamp() - health_file.stat().st_mtime
    file_age_minutes = file_age_seconds / <span class="hljs-number">60</span>
    
    <span class="hljs-keyword">if</span> file_age_minutes &gt; max_age_minutes:
        print(
            <span class="hljs-string">f"Health status file is too old: <span class="hljs-subst">{file_age_minutes:<span class="hljs-number">.1</span>f}</span> minutes "</span>
            <span class="hljs-string">f"(max: <span class="hljs-subst">{max_age_minutes:<span class="hljs-number">.1</span>f}</span> minutes)"</span>,
            file=sys.stderr
        )
        sys.exit(<span class="hljs-number">1</span>)
    
    <span class="hljs-comment"># All checks passed</span>
    print(<span class="hljs-string">f"Healthy (file age: <span class="hljs-subst">{file_age_minutes:<span class="hljs-number">.1</span>f}</span>/<span class="hljs-subst">{max_age_minutes:<span class="hljs-number">.1</span>f}</span> minutes)"</span>)
    sys.exit(<span class="hljs-number">0</span>)


<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">calculate_max_age</span><span class="hljs-params">()</span> -&gt; float:</span>
    <span class="hljs-string">"""Calculate maximum allowed age for health_status.txt based on schedule mode."""</span>
    freq_hours = os.getenv(<span class="hljs-string">'SCHEDULE_FREQUENCY_HOURS'</span>, <span class="hljs-string">''</span>).strip()
    schedule_times = os.getenv(<span class="hljs-string">'SCHEDULE_TIMES'</span>, <span class="hljs-string">''</span>).strip()
    
    <span class="hljs-comment"># Mode 1: Frequency-based (e.g., every 2 hours)</span>
    <span class="hljs-keyword">if</span> freq_hours:
        <span class="hljs-keyword">try</span>:
            hours = float(freq_hours)
            <span class="hljs-keyword">return</span> hours * <span class="hljs-number">60</span> + <span class="hljs-number">10</span>  <span class="hljs-comment"># Allow schedule interval + 10 minute buffer</span>
        <span class="hljs-keyword">except</span> (ValueError, TypeError):
            print(<span class="hljs-string">f"Invalid SCHEDULE_FREQUENCY_HOURS: <span class="hljs-subst">{freq_hours}</span>"</span>, file=sys.stderr)
            <span class="hljs-keyword">return</span> <span class="hljs-number">70</span>  <span class="hljs-comment"># Default fallback: 1 hour + 10 min buffer</span>
    
    <span class="hljs-comment"># Mode 2: Specific times (e.g., 12:00,18:00)</span>
    <span class="hljs-keyword">elif</span> schedule_times:
        <span class="hljs-keyword">try</span>:
            <span class="hljs-keyword">return</span> calculate_max_age_from_times(schedule_times)
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            print(<span class="hljs-string">f"Error calculating age from SCHEDULE_TIMES: <span class="hljs-subst">{e}</span>"</span>, file=sys.stderr)
            <span class="hljs-keyword">return</span> <span class="hljs-number">70</span>
    
    <span class="hljs-comment"># Mode 3: No schedule defined (default to hourly + buffer)</span>
    <span class="hljs-keyword">else</span>:
        print(<span class="hljs-string">"Warning: Neither SCHEDULE_FREQUENCY_HOURS nor SCHEDULE_TIMES set"</span>, file=sys.stderr)
        <span class="hljs-keyword">return</span> <span class="hljs-number">70</span>


<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">calculate_max_age_from_times</span><span class="hljs-params">(schedule_times: str)</span> -&gt; float:</span>
    <span class="hljs-string">"""Calculate maximum age based on SCHEDULE_TIMES."""</span>
    now = datetime.now()
    time_list = [t.strip() <span class="hljs-keyword">for</span> t <span class="hljs-keyword">in</span> schedule_times.split(<span class="hljs-string">','</span>)]
    scheduled_datetimes = []
    
    <span class="hljs-keyword">for</span> time_str <span class="hljs-keyword">in</span> time_list:
        <span class="hljs-keyword">try</span>:
            hour, minute = map(int, time_str.split(<span class="hljs-string">':'</span>))
            scheduled_today = now.replace(hour=hour, minute=minute, second=<span class="hljs-number">0</span>, microsecond=<span class="hljs-number">0</span>)
            scheduled_datetimes.append(scheduled_today)
            scheduled_yesterday = scheduled_today - timedelta(days=<span class="hljs-number">1</span>)
            scheduled_datetimes.append(scheduled_yesterday)
        <span class="hljs-keyword">except</span> (ValueError, IndexError) <span class="hljs-keyword">as</span> e:
            print(<span class="hljs-string">f"Invalid time format '<span class="hljs-subst">{time_str}</span>': <span class="hljs-subst">{e}</span>"</span>, file=sys.stderr)
            <span class="hljs-keyword">continue</span>
    
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> scheduled_datetimes:
        print(<span class="hljs-string">"No valid times found in SCHEDULE_TIMES"</span>, file=sys.stderr)
        <span class="hljs-keyword">return</span> <span class="hljs-number">70</span>
    
    past_times = [dt <span class="hljs-keyword">for</span> dt <span class="hljs-keyword">in</span> scheduled_datetimes <span class="hljs-keyword">if</span> dt &lt;= now]
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> past_times:
        past_times = sorted(scheduled_datetimes)
    
    most_recent = max(past_times)
    minutes_since = (now - most_recent).total_seconds() / <span class="hljs-number">60</span>
    <span class="hljs-keyword">return</span> minutes_since + <span class="hljs-number">10</span>  <span class="hljs-comment"># Add 10 minute buffer</span>


<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    main()
</div></code></pre>
<h4 id="step-2-update-your-dockerfile">Step 2: Update Your Dockerfile</h4>
<p>Ensure these lines exist in your Dockerfile (typically after <code>COPY</code> commands):</p>
<pre class="hljs"><code><div><span class="hljs-comment"># Copy project structure including healthcheck</span>
<span class="hljs-keyword">COPY</span><span class="bash"> scripts/ ./scripts/</span>

<span class="hljs-comment"># Make healthcheck script executable</span>
<span class="hljs-keyword">RUN</span><span class="bash"> chmod +x /app/scripts/*.py</span>

<span class="hljs-comment"># Add healthcheck - interval depends on your schedule</span>
<span class="hljs-keyword">HEALTHCHECK</span><span class="bash"> --interval=2m --timeout=10s --start-period=2m --retries=2 \
  CMD python3 /app/scripts/healthcheck.py</span>
</div></code></pre>
<h4 id="step-3-rebuild-and-restart-containers">Step 3: Rebuild and Restart Containers</h4>
<pre class="hljs"><code><div><span class="hljs-built_in">cd</span> /path/to/your/project
docker compose build
docker compose up -d
</div></code></pre>
<h3 id="healthcheck-configuration-by-schedule-type">Healthcheck Configuration by Schedule Type</h3>
<p><strong>For <code>SCHEDULE_TIMES</code> (specific times like 12:00,18:00):</strong></p>
<pre class="hljs"><code><div><span class="hljs-keyword">HEALTHCHECK</span><span class="bash"> --interval=5m --timeout=10s --start-period=2m --retries=2 \
  CMD python3 /app/scripts/healthcheck.py</span>
</div></code></pre>
<p><strong>For <code>SCHEDULE_FREQUENCY_HOURS=1</code> (hourly):</strong></p>
<pre class="hljs"><code><div><span class="hljs-keyword">HEALTHCHECK</span><span class="bash"> --interval=2m --timeout=10s --start-period=2m --retries=2 \
  CMD python3 /app/scripts/healthcheck.py</span>
</div></code></pre>
<p><strong>For <code>SCHEDULE_FREQUENCY_HOURS=0.25</code> (every 15 minutes):</strong></p>
<pre class="hljs"><code><div><span class="hljs-keyword">HEALTHCHECK</span><span class="bash"> --interval=1m --timeout=10s --start-period=1m --retries=3 \
  CMD python3 /app/scripts/healthcheck.py</span>
</div></code></pre>
<p><strong>For web applications (always running):</strong></p>
<pre class="hljs"><code><div><span class="hljs-keyword">HEALTHCHECK</span><span class="bash"> --interval=30s --timeout=10s --start-period=60s --retries=3 \
  CMD curl -f http://localhost:8000/health || <span class="hljs-built_in">exit</span> 1</span>
</div></code></pre>
<h3 id="verifying-healthchecks">Verifying Healthchecks</h3>
<pre class="hljs"><code><div><span class="hljs-comment"># Check healthcheck status</span>
docker ps

<span class="hljs-comment"># Detailed health information</span>
docker inspect &lt;container-name&gt; | grep -A 20 Health

<span class="hljs-comment"># Test healthcheck manually</span>
docker <span class="hljs-built_in">exec</span> &lt;container-name&gt; python3 /app/scripts/healthcheck.py

<span class="hljs-comment"># Watch healthcheck in real-time</span>
watch -n 5 <span class="hljs-string">'docker ps --format "table {{.Names}}\t{{.Status}}"'</span>
</div></code></pre>
<h2 id="health-status-file-format">Health Status File Format</h2>
<p>The <code>base_alert.py</code> writes a structured health status file that the healthcheck script validates:</p>
<pre class="hljs"><code><div>OK 2025-12-16T12:05:30+02:00
ALERT_TYPE: MastersNavigationAuditAlert
TIMEZONE: Europe/Athens
</div></code></pre>
<p>Or for errors:</p>
<pre class="hljs"><code><div>ERROR 2025-12-16T12:05:30+02:00
ALERT_TYPE: MastersNavigationAuditAlert
TIMEZONE: Europe/Athens
ERROR_MSG: Database connection timeout after 30 seconds
</div></code></pre>
<p><strong>Format rules:</strong></p>
<ul>
<li>Line 1: <code>STATUS TIMESTAMP</code> (STATUS is &quot;OK&quot; or &quot;ERROR&quot;, TIMESTAMP is ISO 8601 with timezone)</li>
<li>Line 2: <code>ALERT_TYPE: ClassName</code> (name of the alert class)</li>
<li>Line 3: <code>TIMEZONE: timezone_name</code> (e.g., &quot;Europe/Athens&quot;, &quot;UTC&quot;)</li>
<li>Line 4 (optional): <code>ERROR_MSG: message</code> (only present if STATUS is ERROR)</li>
</ul>
<p><strong>Timezone handling:</strong></p>
<ul>
<li>The timestamp in line 1 is timezone-aware (includes +HH:MM offset)</li>
<li>The healthcheck uses <code>SCHEDULE_TIMES_TIMEZONE</code> (if set), then <code>TIMEZONE</code>, then defaults to UTC</li>
<li>File age is calculated using timezone-aware datetime arithmetic</li>
</ul>
<h2 id="usage">Usage</h2>
<h3 id="running-the-monitor">Running the Monitor</h3>
<p><strong>Foreground (for testing):</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment"># Ubuntu/Linux</span>
<span class="hljs-built_in">cd</span> /srv/repos/_docker_monitoring
python3 docker_health_monitor.py

<span class="hljs-comment"># Mac/Development</span>
<span class="hljs-built_in">cd</span> ~/dev/alerts/_docker_monitoring
python3 docker_health_monitor.py
</div></code></pre>
<p>You should see output like:</p>
<pre class="hljs"><code><div>======================================================================
Multi-Project Docker Health Monitor initialized
Server: Production Server
Default alert recipients: admin@example.com, ops@example.com
Check interval: 30 seconds
Retry delay: 15.0 minutes
======================================================================
======================================================================
▶ MULTI-PROJECT DOCKER HEALTH MONITOR STARTED
======================================================================
</div></code></pre>
<p><strong>Background with nohup:</strong></p>
<pre class="hljs"><code><div>nohup python3 docker_health_monitor.py &gt; /dev/null 2&gt;&amp;1 &amp;
</div></code></pre>
<p><strong>As a systemd service (Ubuntu/Linux - recommended for production):</strong></p>
<p>Create <code>/etc/systemd/system/docker-health-monitor.service</code>:</p>
<pre class="hljs"><code><div><span class="hljs-section">[Unit]</span>
<span class="hljs-attr">Description</span>=Multi-Project Docker Health Monitor
<span class="hljs-attr">After</span>=docker.service
<span class="hljs-attr">Requires</span>=docker.service

<span class="hljs-section">[Service]</span>
<span class="hljs-attr">Type</span>=simple
<span class="hljs-attr">User</span>=root
<span class="hljs-attr">WorkingDirectory</span>=/srv/repos/_docker_monitoring
<span class="hljs-attr">ExecStart</span>=/usr/bin/python3 /srv/repos/_docker_monitoring/docker_health_monitor.py
<span class="hljs-attr">Restart</span>=always
<span class="hljs-attr">RestartSec</span>=<span class="hljs-number">10</span>
<span class="hljs-attr">StandardOutput</span>=journal
<span class="hljs-attr">StandardError</span>=journal

<span class="hljs-section">[Install]</span>
<span class="hljs-attr">WantedBy</span>=multi-user.target
</div></code></pre>
<p><strong>Important:</strong> If running as non-root user:</p>
<pre class="hljs"><code><div><span class="hljs-comment"># Add user to docker group</span>
sudo usermod -aG docker your-username

<span class="hljs-comment"># Then use this in the service file</span>
User=your-username
</div></code></pre>
<p>Enable and start:</p>
<pre class="hljs"><code><div>sudo systemctl daemon-reload
sudo systemctl <span class="hljs-built_in">enable</span> docker-health-monitor
sudo systemctl start docker-health-monitor
</div></code></pre>
<p>Check status:</p>
<pre class="hljs"><code><div>sudo systemctl status docker-health-monitor
sudo journalctl -u docker-health-monitor -f
</div></code></pre>
<h3 id="viewing-logs">Viewing Logs</h3>
<pre class="hljs"><code><div><span class="hljs-comment"># Real-time monitoring (from script directory)</span>
tail -f logs/monitor.log

<span class="hljs-comment"># View recent activity</span>
tail -100 logs/monitor.log

<span class="hljs-comment"># Search for specific container</span>
grep <span class="hljs-string">"container-name"</span> logs/monitor.log

<span class="hljs-comment"># View all status changes</span>
grep <span class="hljs-string">"→"</span> logs/monitor.log
</div></code></pre>
<h2 id="how-it-works">How It Works</h2>
<h3 id="two-phase-verification-pattern">Two-Phase Verification Pattern</h3>
<p>The monitor uses a two-phase approach to eliminate false positives:</p>
<p><strong>Phase 1: Initial Health Checks (Concurrent)</strong></p>
<ol>
<li>Monitor fetches all running Docker containers</li>
<li>Submits each container to thread pool (max 30 concurrent checks)</li>
<li>Workers call <code>get_container_health()</code> via Docker API</li>
<li>Results are categorized:
<ul>
<li><strong>No change:</strong> Update last_check timestamp only</li>
<li><strong>Became unhealthy:</strong> Add to retry queue (includes unknown→unhealthy, starting→unhealthy, healthy→unhealthy)</li>
<li><strong>Became healthy:</strong> Add to immediate alert queue (recovery notification)</li>
</ul>
</li>
</ol>
<p><strong>Transition: Main Thread Sleep</strong></p>
<ul>
<li>If retry queue is empty: Sleep for <code>check_interval_sec</code> (30s default), then restart loop</li>
<li>If retry queue has containers: Log count, then sleep for <code>wait_and_check_again_min</code> (15 min default)</li>
<li>Sleep is interruptible every 1 second to allow graceful shutdown</li>
</ul>
<p><strong>Phase 2: Recheck Unhealthy (Concurrent)</strong></p>
<ol>
<li>Submit all queued containers to thread pool for recheck</li>
<li>Workers call <code>recheck_single_container()</code> via Docker API</li>
<li>For each result:
<ul>
<li><strong>Still unhealthy:</strong> Fetch logs, send alert email</li>
<li><strong>Now healthy:</strong> Log recovery, update state, no alert</li>
<li><strong>Not found:</strong> Send not_found alert</li>
</ul>
</li>
</ol>
<p><strong>After Phase 2:</strong></p>
<ul>
<li>Sleep for <code>check_interval_sec</code> (30s)</li>
<li>Return to Phase 1</li>
</ul>
<h3 id="why-this-pattern-works">Why This Pattern Works</h3>
<p><strong>Eliminates False Positives:</strong></p>
<ul>
<li>Transient failures during deployments won't trigger alerts</li>
<li>Network hiccups are given time to resolve</li>
<li>Container restarts are given time to complete</li>
<li>Only persistent issues (lasting 15+ minutes) generate alerts</li>
</ul>
<p><strong>Efficient Resource Usage:</strong></p>
<ul>
<li>Thread pool limits concurrent Docker API calls to 30</li>
<li>Main thread sleeps during wait (no wasted CPU)</li>
<li>Interruptible sleep allows clean shutdown</li>
<li>Scales to hundreds of containers efficiently</li>
</ul>
<p><strong>Simple and Reliable:</strong></p>
<ul>
<li>No complex background task scheduling</li>
<li>No retry futures to track</li>
<li>Single main loop is easy to reason about</li>
<li>Thread-safe state management</li>
<li>Works across platforms (Mac, Ubuntu, other Linux)</li>
</ul>
<h3 id="example-timeline">Example Timeline</h3>
<pre class="hljs"><code><div>00:00 - Phase 1: Check 50 containers (concurrent)
00:05 - Results: 48 healthy, 2 unhealthy (app-1, db-1)
00:05 - Main thread sleeps for 15 minutes (interruptible)
00:20 - Phase 2: Recheck app-1 and db-1 (concurrent)
00:20 - Results: app-1 recovered, db-1 still unhealthy
00:20 - Actions: Log app-1 recovery, send alert for db-1 with logs
00:20 - Sleep for 30 seconds
00:20:30 - Return to Phase 1
</div></code></pre>
<h2 id="project-specific-routing">Project-Specific Routing</h2>
<p>Route alerts to different teams based on container or project names:</p>
<pre class="hljs"><code><div><span class="hljs-comment"># In .env</span>
CONTAINER_ALERT_ROUTING=passage-plan:maritime@example.com;vessel-cert:compliance@example.com;hot-works:safety@example.com
</div></code></pre>
<p><strong>How it works:</strong></p>
<ul>
<li>Pattern matching against container name OR project name</li>
<li>First match wins</li>
<li>Falls back to <code>HEALTH_CHECK_ALERT_EMAILS</code> if no match</li>
<li>Multiple recipients per pattern supported (comma-separated)</li>
</ul>
<p><strong>Example:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment"># Container: passage-plan-web-1</span>
<span class="hljs-comment"># Project: passage-plan</span>
<span class="hljs-comment"># Pattern: passage-plan</span>
<span class="hljs-comment"># Result: Email sent to maritime@example.com</span>
</div></code></pre>
<h2 id="alert-examples">Alert Examples</h2>
<h3 id="critical-alert-unhealthy-container">Critical Alert (Unhealthy Container)</h3>
<pre class="hljs"><code><div>Subject: CRITICAL!! CRITICAL: [passage-plan] passage-plan-web-1 - Health Status Changed

Docker Container Health Alert
==============================

Server:          Production Server
Project:         passage-plan
Container:       passage-plan-web-1
Status Change:   healthy → unhealthy
Severity:        CRITICAL
Time:            2025-12-15 14:23:45

Details:
--------
Container remained unhealthy after 15.0 minute(s).

Recent logs:

[2025-12-15 14:20:12] ERROR: Database connection failed
[2025-12-15 14:20:13] ERROR: Retrying in 5 seconds...
[2025-12-15 14:20:18] ERROR: Still cannot connect
...

Action Required:
----------------
1. Check container logs:
   docker logs passage-plan-web-1

2. Inspect container:
   docker inspect passage-plan-web-1

3. Restart container:
   docker restart passage-plan-web-1
   
   Or navigate to project and restart:
   cd /path/to/passage-plan
   docker compose restart

4. Check application health endpoint

5. Review recent code changes or deployments


Project Context:
----------------
Container name: passage-plan-web-1
Project name:   passage-plan
Status:         unhealthy

---
Automated alert from Multi-Project Docker Health Monitor
Server: Production Server
Monitoring all containers with healthchecks
</div></code></pre>
<h3 id="recovery-alert">Recovery Alert</h3>
<pre class="hljs"><code><div>Subject: INFO INFO: [passage-plan] passage-plan-web-1 - Health Status Changed

Docker Container Health Alert
==============================

Server:          Production Server
Project:         passage-plan
Container:       passage-plan-web-1
Status Change:   unhealthy → healthy
Severity:        INFO
Time:            2025-12-15 14:25:30

Details:
--------
Container recovered to healthy status.

Action Required:
----------------
Monitor the situation and check logs for more information.
</div></code></pre>
<h3 id="container-not-found-alert">Container Not Found Alert</h3>
<pre class="hljs"><code><div>Subject: ERROR! ERROR: [passage-plan] passage-plan-worker-1 - Health Status Changed

Docker Container Health Alert
==============================

Server:          Production Server
Project:         passage-plan
Container:       passage-plan-worker-1
Status Change:   healthy → not_found
Severity:        ERROR
Time:            2025-12-15 14:30:15

Details:
--------
Container is no longer running or has been removed.

Action Required:
----------------
1. Check if container is running:
   docker ps -a | grep passage-plan-worker-1

2. Navigate to project directory:
   cd /path/to/passage-plan

3. Check docker-compose status:
   docker compose ps

4. Restart services:
   docker compose up -d

5. Check docker-compose.yml configuration
</div></code></pre>
<h2 id="troubleshooting">Troubleshooting</h2>
<h3 id="monitor-not-starting">Monitor Not Starting</h3>
<p><strong>1. Check configuration loading:</strong></p>
<pre class="hljs"><code><div>python3 -c <span class="hljs-string">"from decouple import config; print('SMTP_HOST:', config('SMTP_HOST')); print('EMAILS:', config('HEALTH_CHECK_ALERT_EMAILS'))"</span>
</div></code></pre>
<p><strong>2. Verify Docker access:</strong></p>
<pre class="hljs"><code><div>docker ps
<span class="hljs-comment"># If this fails, you don't have Docker permissions</span>
</div></code></pre>
<p><strong>3. Check Python dependencies:</strong></p>
<pre class="hljs"><code><div>python3 -c <span class="hljs-string">"import docker; import decouple; print('Dependencies OK')"</span>
</div></code></pre>
<h3 id="containers-not-being-monitored">Containers Not Being Monitored</h3>
<p><strong>Check if container has healthcheck:</strong></p>
<pre class="hljs"><code><div>docker inspect &lt;container-name&gt; | grep -A 20 Health
</div></code></pre>
<p><strong>If no healthcheck found:</strong></p>
<ul>
<li>Add <code>scripts/healthcheck.py</code> to your project</li>
<li>Update Dockerfile with HEALTHCHECK line</li>
<li>Rebuild: <code>docker compose build</code></li>
<li>Restart: <code>docker compose up -d</code></li>
</ul>
<p><strong>If healthcheck exists but shows &quot;starting&quot; status:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment"># Increase start_period in Dockerfile</span>
HEALTHCHECK --start-period=5m ...

<span class="hljs-comment"># Or check if healthcheck script has errors</span>
docker <span class="hljs-built_in">exec</span> &lt;container&gt; python3 /app/scripts/healthcheck.py
</div></code></pre>
<h3 id="emails-not-sending">Emails Not Sending</h3>
<p><strong>Test SMTP connection (port 587 - STARTTLS):</strong></p>
<pre class="hljs"><code><div>python3 &lt;&lt; <span class="hljs-string">'EOF'</span>
import smtplib
from decouple import config

try:
    server = smtplib.SMTP(config(<span class="hljs-string">'SMTP_HOST'</span>), int(config(<span class="hljs-string">'SMTP_PORT'</span>, 587)))
    server.starttls()
    server.login(config(<span class="hljs-string">'SMTP_USER'</span>), config(<span class="hljs-string">'SMTP_PASS'</span>))
    <span class="hljs-built_in">print</span>(<span class="hljs-string">'✓ SMTP connection successful (STARTTLS)'</span>)
    server.quit()
except Exception as e:
    <span class="hljs-built_in">print</span>(f<span class="hljs-string">'✗ SMTP connection failed: {e}'</span>)
EOF
</div></code></pre>
<p><strong>Test SMTP connection (port 465 - SSL):</strong></p>
<pre class="hljs"><code><div>python3 &lt;&lt; <span class="hljs-string">'EOF'</span>
import smtplib
from decouple import config

try:
    server = smtplib.SMTP_SSL(config(<span class="hljs-string">'SMTP_HOST'</span>), int(config(<span class="hljs-string">'SMTP_PORT'</span>, 465)))
    server.login(config(<span class="hljs-string">'SMTP_USER'</span>), config(<span class="hljs-string">'SMTP_PASS'</span>))
    <span class="hljs-built_in">print</span>(<span class="hljs-string">'✓ SMTP connection successful (SSL)'</span>)
    server.quit()
except Exception as e:
    <span class="hljs-built_in">print</span>(f<span class="hljs-string">'✗ SMTP connection failed: {e}'</span>)
EOF
</div></code></pre>
<p><strong>Common SMTP issues:</strong></p>
<ul>
<li><code>[SSL: WRONG_VERSION_NUMBER]</code> → Wrong port for connection type (try changing port 465↔587)</li>
<li><code>Authentication failed</code> → Wrong username/password, or app password required</li>
<li><code>Connection refused</code> → Wrong SMTP_HOST or firewall blocking</li>
</ul>
<p><strong>For Gmail users:</strong></p>
<ol>
<li>Enable 2-Factor Authentication</li>
<li>Generate App Password: https://myaccount.google.com/apppasswords</li>
<li>Use App Password in <code>SMTP_PASS</code> (not regular password)</li>
<li>Use <code>SMTP_PORT=587</code></li>
</ol>
<p><strong>For custom SMTP servers:</strong></p>
<ul>
<li>Contact your email admin for correct settings</li>
<li>Port 587 (STARTTLS) is more common than 465 (SSL)</li>
<li>Some servers require different authentication methods</li>
</ul>
<h3 id="false-positives-during-deployments">False Positives During Deployments</h3>
<p><strong>Increase retry wait time:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment"># In .env</span>
WAIT_AND_CHECK_AGAIN_MIN=20
</div></code></pre>
<p><strong>Or improve healthcheck <code>start_period</code>:</strong></p>
<pre class="hljs"><code><div><span class="hljs-keyword">HEALTHCHECK</span><span class="bash"> --start-period=5m ...</span>
</div></code></pre>
<h3 id="healthcheck-script-errors">Healthcheck Script Errors</h3>
<p><strong>Test the healthcheck script:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment"># Inside container</span>
docker <span class="hljs-built_in">exec</span> &lt;container&gt; python3 /app/scripts/healthcheck.py

<span class="hljs-comment"># Check health file exists</span>
docker <span class="hljs-built_in">exec</span> &lt;container&gt; ls -lh /app/logs/health_status.txt

<span class="hljs-comment"># Check health file content</span>
docker <span class="hljs-built_in">exec</span> &lt;container&gt; cat /app/logs/health_status.txt

<span class="hljs-comment"># Check environment variables</span>
docker <span class="hljs-built_in">exec</span> &lt;container&gt; env | grep SCHEDULE
</div></code></pre>
<h2 id="best-practices">Best Practices</h2>
<h3 id="healthcheck-design-principles">Healthcheck Design Principles</h3>
<p><strong>Good healthcheck characteristics:</strong></p>
<ul>
<li>Checks actual application functionality</li>
<li>Completes in &lt; 1 second</li>
<li>Has appropriate start_period for slow-starting apps</li>
<li>Uses reasonable interval (1-5 minutes for scheduled tasks)</li>
<li>Includes retry logic (retries: 2-3)</li>
</ul>
<p><strong>Bad healthcheck characteristics:</strong></p>
<ul>
<li>Only checks if port is open</li>
<li>Takes too long to execute (&gt; 5 seconds)</li>
<li>No start_period (fails during boot)</li>
<li>Too frequent interval (&lt; 30s for scheduled tasks)</li>
</ul>
<h3 id="alert-tuning">Alert Tuning</h3>
<p><strong>For frequently restarting containers:</strong></p>
<pre class="hljs"><code><div>WAIT_AND_CHECK_AGAIN_MIN=20
HEALTH_CHECK_INTERVAL_SEC=60
</div></code></pre>
<p><strong>For critical services:</strong></p>
<pre class="hljs"><code><div>WAIT_AND_CHECK_AGAIN_MIN=5
HEALTH_CHECK_INTERVAL_SEC=15
</div></code></pre>
<p><strong>For development environments:</strong></p>
<pre class="hljs"><code><div>WAIT_AND_CHECK_AGAIN_MIN=1  <span class="hljs-comment"># Fast testing</span>
HEALTH_CHECK_INTERVAL_SEC=60
</div></code></pre>
<h3 id="production-deployment-checklist">Production Deployment Checklist</h3>
<ul>
<li><input type="checkbox" id="checkbox7"><label for="checkbox7">Test in staging environment first</label></li>
<li><input type="checkbox" id="checkbox8"><label for="checkbox8">Start with longer retry delays (15-20 minutes)</label></li>
<li><input type="checkbox" id="checkbox9"><label for="checkbox9">Monitor logs daily for first week</label></li>
<li><input type="checkbox" id="checkbox10"><label for="checkbox10">Verify SMTP credentials work (test both ports if needed)</label></li>
<li><input type="checkbox" id="checkbox11"><label for="checkbox11">Test with intentional container failure</label></li>
<li><input type="checkbox" id="checkbox12"><label for="checkbox12">Set up systemd service for automatic restart (Ubuntu)</label></li>
<li><input type="checkbox" id="checkbox13"><label for="checkbox13">Configure project-specific routing</label></li>
<li><input type="checkbox" id="checkbox14"><label for="checkbox14">Add monitor email to allow-list</label></li>
<li><input type="checkbox" id="checkbox15"><label for="checkbox15">Document alert response procedures</label></li>
<li><input type="checkbox" id="checkbox16"><label for="checkbox16">Verify all containers have healthchecks</label></li>
</ul>
<h2 id="graceful-shutdown">Graceful Shutdown</h2>
<p>The monitor handles <code>SIGTERM</code> and <code>SIGINT</code> signals properly:</p>
<p><strong>Shutdown behavior:</strong></p>
<ol>
<li>Signal received (SIGTERM, SIGINT, or Ctrl+C)</li>
<li><code>shutdown_requested</code> flag set</li>
<li>Current operation completes:
<ul>
<li>If in Phase 1: Finishes collecting results</li>
<li>If sleeping: Interrupts sleep within 1 second</li>
<li>If in Phase 2: Finishes rechecks and alerts</li>
</ul>
</li>
<li>ThreadPoolExecutor shutdown initiated</li>
<li>Waits for in-flight Docker API calls</li>
<li>Exits cleanly</li>
</ol>
<p><strong>The interruptible sleep ensures:</strong></p>
<ul>
<li>Quick response to shutdown signals</li>
<li>No alerts lost during shutdown</li>
<li>Clean exit without hanging</li>
</ul>
<h2 id="faq">FAQ</h2>
<p><strong>Q: Does this work with Docker Swarm?</strong><br>
A: Yes, monitors all containers visible to Docker API.</p>
<p><strong>Q: Can I monitor containers without healthchecks?</strong><br>
A: No. Containers must have healthchecks defined. Monitor skips containers without them.</p>
<p><strong>Q: How many containers can this monitor?</strong><br>
A: Tested with 100+ containers. Scales efficiently with 30 concurrent workers.</p>
<p><strong>Q: What happens during deployments?</strong><br>
A: The 15-minute retry prevents false alerts. Containers that recover within retry window won't trigger alerts.</p>
<p><strong>Q: Can I get Slack notifications instead of email?</strong><br>
A: Yes, modify <code>send_alert_email()</code> method to call your webhook.</p>
<p><strong>Q: Why doesn't my container appear in monitoring?</strong><br>
A: Three common reasons:</p>
<ol>
<li>No healthcheck defined in Dockerfile</li>
<li>Container just started (wait 30 seconds for first check)</li>
<li>Healthcheck script has errors (test manually)</li>
</ol>
<p><strong>Q: Can I test without waiting 15 minutes?</strong><br>
A: Yes, temporarily set <code>WAIT_AND_CHECK_AGAIN_MIN=1</code> in .env</p>
<p><strong>Q: Does it work on Mac?</strong><br>
A: Yes! The script uses relative paths and works on Mac, Ubuntu, and other Linux distributions.</p>
<p><strong>Q: What's the difference between port 465 and 587?</strong><br>
A: Port 587 uses STARTTLS (most common), port 465 uses direct SSL. The script detects and uses the appropriate method automatically.</p>
<p><strong>Q: How do I find my container name for <code>docker exec</code>?</strong>
A: Run <code>docker ps --format &quot;{{.Names}}&quot;</code> to list all container names. Use the name from the NAMES column, not the service name from docker-compose.yml.</p>
<p><strong>Q: Why does my healthcheck show a different max age than expected?</strong>
A: The max age is calculated as: <code>SCHEDULE_FREQUENCY_HOURS × 60 + 10 minutes buffer</code>. For time-based schedules, it's <code>minutes since last scheduled time + 10 minutes</code>. Check your <code>SCHEDULE_FREQUENCY_HOURS</code> or <code>SCHEDULE_TIMES</code> environment variable.</p>
<p><strong>Q: What timezone does the healthcheck use?</strong>
A: Priority order: <code>SCHEDULE_TIMES_TIMEZONE</code> &gt; <code>TIMEZONE</code> &gt; UTC (default). Set <code>SCHEDULE_TIMES_TIMEZONE=Europe/Athens</code> in your project's <code>.env</code> for time-based schedules.</p>
<p><strong>Q: Can I test the healthcheck without waiting for it to fail naturally?</strong>
A: Yes, use the Python method in &quot;Testing Healthcheck Failures&quot; to write an old timestamp or ERROR status to the health file, then run the healthcheck script manually.</p>
<h2 id="performance-characteristics">Performance Characteristics</h2>
<p><strong>CPU:</strong></p>
<ul>
<li>Idle: ~0-1%</li>
<li>Phase 1: 5-15% (depends on container count)</li>
<li>Phase 2: 2-10%</li>
</ul>
<p><strong>Memory:</strong></p>
<ul>
<li>Base: ~50-80 MB</li>
<li>Per container: ~1-2 MB</li>
<li>100 containers: ~150-250 MB total</li>
</ul>
<p><strong>Disk:</strong></p>
<ul>
<li>Log files: Max 50 MB (10 MB × 5 rotated files)</li>
<li>Relative to script location</li>
</ul>
<p><strong>Timing (50 containers, 30 workers):</strong></p>
<ul>
<li>Phase 1: ~2-3 seconds</li>
<li>Sleep: 15 minutes (configurable)</li>
<li>Phase 2: ~1 second</li>
<li>Total cycle: ~15 minutes 6 seconds</li>
</ul>
<h2 id="support">Support</h2>
<p>For issues:</p>
<ol>
<li>Check logs: <code>tail -f logs/monitor.log</code> (from script directory)</li>
<li>Verify configuration: <code>python3 -c &quot;from decouple import config; print(config('SMTP_HOST'))&quot;</code></li>
<li>Test SMTP: See Troubleshooting section (test both ports if needed)</li>
<li>Ensure healthchecks: <code>docker inspect &lt;container&gt; | grep -A 10 Health</code></li>
<li>Check Docker permissions: <code>docker ps</code></li>
</ol>
<h2 id="changes-from-previous-versions">Changes from Previous Versions</h2>
<p><strong>Version 2.2 (Current):</strong></p>
<ul>
<li>Added timezone-aware healthcheck with structured file parsing</li>
<li>Added <code>parse_health_file()</code> for robust health status validation</li>
<li>Added <code>get_effective_timezone()</code> for timezone precedence</li>
<li>Improved error messages with status, alert type, and age information</li>
<li>Added atomic write in <code>base_alert.py</code> to prevent file corruption</li>
<li>Enhanced documentation for testing and troubleshooting</li>
</ul>
<p><strong>Version 2.1:</strong></p>
<ul>
<li>Fixed <code>became_unhealthy</code> logic to trigger on <code>unknown→unhealthy</code> transitions</li>
<li>Added interruptible sleep with 1-second intervals</li>
<li>Fixed SMTP port handling (auto-detects 587 vs 465)</li>
<li>Made log paths relative and cross-platform compatible</li>
<li>Improved shutdown handling</li>
</ul>
<p><strong>Version 2.0:</strong></p>
<ul>
<li>Initial two-phase verification pattern</li>
<li>Thread pool for concurrent health checks</li>
<li>Project-aware alerting</li>
</ul>
<hr>
<p><strong>Version:</strong> 2.2<br>
<strong>Last Updated:</strong> December 2025<br>
<strong>Python Version:</strong> 3.7+<br>
<strong>Docker API Version:</strong> Compatible with Docker Engine 19.03+<br>
<strong>Platforms:</strong> Ubuntu, Mac, other Linux distributions</p>

</body>
</html>
